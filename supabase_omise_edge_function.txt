
// Updated Supabase Edge Function to handle Omise PromptPay QR Code
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2.7.1'

const OMISE_SECRET_KEY = Deno.env.get('OMISE_SECRET_KEY')
const SUPABASE_URL = Deno.env.get('SUPABASE_URL')
const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')

export const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, OPTIONS',
}

serve(async (req) => {
  if (req.method === 'OPTIONS') return new Response('ok', { headers: corsHeaders })

  try {
    const { token, amount, userId, currency = 'thb' } = await req.json()

    // 1. Create Charge
    const chargeResponse = await fetch('https://api.omise.co/charges', {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${btoa(OMISE_SECRET_KEY + ':')}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        amount: amount * 100,
        currency: currency,
        card: token.startsWith('tokn_') ? token : undefined,
        source: token.startsWith('src_') ? token : undefined,
        return_uri: 'https://underwear-app-nine.vercel.app',
        metadata: { userId: userId }
      })
    })

    const charge = await chargeResponse.json()
    console.log('Charge created:', charge.id, 'Status:', charge.status);

    if (charge.status === 'failed') {
      throw new Error(charge.failure_message || 'Charge failed')
    }

    // 2. Handle Redirection (PromptPay / Rabbit LinePay / Internet Banking)
    // สำหรับ PromptPay, Omise จะให้ authorize_uri เพื่อไปหน้า QR Code
    if (charge.authorize_uri || charge.status === 'pending') {
      return new Response(JSON.stringify({ 
        success: true, 
        status: 'pending', 
        authorize_uri: charge.authorize_uri || (charge.source && charge.source.references ? charge.source.references.barcode : null)
      }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200
      })
    }

    // 3. Handle Instant Success (Credit Card)
    if (charge.status === 'successful') {
      const supabase = createClient(SUPABASE_URL!, SUPABASE_SERVICE_ROLE_KEY!)
      await supabase.rpc('add_coins', { user_id: userId, amount: amount })
      
      return new Response(JSON.stringify({ success: true, status: 'successful' }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' },
        status: 200
      })
    }

    throw new Error('Unexpected charge status: ' + charge.status)

  } catch (error) {
    console.error('Error:', error.message)
    return new Response(JSON.stringify({ error: error.message }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 400
    })
  }
})
