
-- Enable UUID extension
create extension if not exists "uuid-ossp";

-- 1. PROFILES (ตารางข้อมูลผู้ใช้)
create table if not exists public.profiles (
  id uuid references auth.users on delete cascade not null primary key,
  username text unique,
  avatar text,
  cover_image text,
  role text default 'supporter' check (role in ('model', 'organizer', 'supporter')),
  bio text,
  location text,
  wallet_balance decimal default 0,
  followers int default 0,
  following int default 0,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 2. PRODUCTS (ตารางสินค้า)
create table if not exists public.products (
  id uuid default uuid_generate_v4() primary key,
  seller_id uuid references public.profiles(id) not null,
  name text not null,
  description text,
  price decimal not null,
  stock integer default 0,
  image text,
  colors text[], -- เก็บเป็น Array ของรหัสสี เช่น ['#FFFFFF', '#000000']
  sizes text[],  -- เก็บเป็น Array ของไซส์ เช่น ['M', 'L', 'XL']
  sold integer default 0,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 3. ROOMS (ห้อง Live สด และ Chat)
create table if not exists public.rooms (
  id uuid default uuid_generate_v4() primary key,
  host_id uuid references public.profiles(id) not null,
  title text not null,
  cover_image text,
  video_url text, -- URL ของไฟล์วิดีโอ (ถ้ามี)
  youtube_id text, -- ID ของ YouTube (ถ้าใช้ YouTube)
  viewer_count integer default 0,
  
  -- ส่วนของการประมูล (Auction)
  is_auction boolean default false,
  auction_end_time bigint, -- เวลาจบการประมูล (Timestamp)
  auction_starting_price decimal,
  current_bid decimal default 0,
  top_bidder_name text, -- ชื่อคนประมูลสูงสุด
  
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 4. MESSAGES (ข้อความแชท)
create table if not exists public.messages (
  id uuid default uuid_generate_v4() primary key,
  room_id uuid references public.rooms(id) on delete cascade not null,
  sender_id uuid references public.profiles(id),
  content text,
  type text default 'text', -- 'text', 'image', 'gift', 'bid'
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 5. ORDERS (คำสั่งซื้อ)
create table if not exists public.orders (
  id uuid default uuid_generate_v4() primary key,
  buyer_id uuid references public.profiles(id) not null,
  total_amount decimal not null,
  status text default 'pending', -- 'pending', 'shipping', 'delivered', 'cancelled'
  tracking_number text,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- 6. ORDER ITEMS (รายการสินค้าในคำสั่งซื้อ)
create table if not exists public.order_items (
  id uuid default uuid_generate_v4() primary key,
  order_id uuid references public.orders(id) on delete cascade not null,
  product_id uuid references public.products(id),
  quantity integer default 1,
  color text,
  size text,
  price_at_purchase decimal not null
);

-- เปิดใช้งาน Realtime (เพื่อให้แชทและยอดประมูลเด้งทันที)
begin;
  drop publication if exists supabase_realtime;
  create publication supabase_realtime for table messages, rooms, profiles;
commit;

-- ตั้งค่าความปลอดภัย (RLS Policies)
-- ลบ Policy เดิมก่อนสร้างใหม่เพื่อป้องกัน Error: policy already exists
alter table public.profiles enable row level security;
drop policy if exists "Public profiles are viewable by everyone." on public.profiles;
create policy "Public profiles are viewable by everyone." on public.profiles for select using (true);

drop policy if exists "Users can insert their own profile." on public.profiles;
create policy "Users can insert their own profile." on public.profiles for insert with check (auth.uid() = id);

drop policy if exists "Users can update own profile." on public.profiles;
create policy "Users can update own profile." on public.profiles for update using (auth.uid() = id);

alter table public.products enable row level security;
drop policy if exists "Products are viewable by everyone." on public.products;
create policy "Products are viewable by everyone." on public.products for select using (true);

drop policy if exists "Sellers can insert products." on public.products;
create policy "Sellers can insert products." on public.products for insert with check (auth.uid() = seller_id);

drop policy if exists "Sellers can update own products." on public.products;
create policy "Sellers can update own products." on public.products for update using (auth.uid() = seller_id);

alter table public.rooms enable row level security;
drop policy if exists "Rooms are viewable by everyone." on public.rooms;
create policy "Rooms are viewable by everyone." on public.rooms for select using (true);

drop policy if exists "Hosts can insert rooms." on public.rooms;
create policy "Hosts can insert rooms." on public.rooms for insert with check (auth.uid() = host_id);

drop policy if exists "Hosts can update own rooms." on public.rooms;
create policy "Hosts can update own rooms." on public.rooms for update using (auth.uid() = host_id);

alter table public.messages enable row level security;
drop policy if exists "Messages are viewable by everyone." on public.messages;
create policy "Messages are viewable by everyone." on public.messages for select using (true);

drop policy if exists "Authenticated users can insert messages." on public.messages;
create policy "Authenticated users can insert messages." on public.messages for insert with check (auth.role() = 'authenticated');

-- [ส่วนสำคัญ] TRIGGER SETUP สำหรับสร้าง Profile อัตโนมัติเมื่อ User สมัครใหม่
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.profiles (id, username, role, avatar, cover_image)
  VALUES (
    new.id,
    COALESCE(new.raw_user_meta_data->>'username', split_part(new.email, '@', 1)),
    COALESCE(new.raw_user_meta_data->>'role', 'supporter'),
    'https://ui-avatars.com/api/?name=' || COALESCE(new.raw_user_meta_data->>'username', 'User') || '&background=111827&color=dc2626&size=256&bold=true',
    'https://images.unsplash.com/photo-1614850523060-8da1d56ae167?w=1200&q=80'
  )
  ON CONFLICT (id) DO NOTHING;
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

-- [ส่วนสำคัญ] Backfill Data: ดึง User เก่าที่ยังไม่มี Profile ให้มาใส่ในตาราง
INSERT INTO public.profiles (id, username, role, avatar, cover_image)
SELECT 
  id, 
  COALESCE(raw_user_meta_data->>'username', split_part(email, '@', 1)),
  COALESCE(raw_user_meta_data->>'role', 'supporter'),
  'https://ui-avatars.com/api/?name=' || COALESCE(raw_user_meta_data->>'username', 'User') || '&background=111827&color=dc2626&size=256&bold=true',
  'https://images.unsplash.com/photo-1614850523060-8da1d56ae167?w=1200&q=80'
FROM auth.users
WHERE id NOT IN (SELECT id FROM public.profiles);
